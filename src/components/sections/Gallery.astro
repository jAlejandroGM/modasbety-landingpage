---
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import { SOCIAL_LINKS, MESSAGES } from "../../data/siteData";

const images = await Astro.glob("/src/assets/vestidos/*.{jpeg,jpg,png}");
---

<section
  id="galeria"
  class="flex flex-col items-center gap-8 lg:gap-12 max-w-[1800px] mx-auto px-4 sm:px-6 py-16"
  aria-labelledby="galeria-titulo"
>
  <div class="space-y-2">
    <h2 id="galeria-titulo">Colección Exclusiva</h2>
    <p
      class="text-center text-sm md:text-base lg:text-xl text-balance text-gray-300 max-w-xl m-auto italic"
    >
      Algunos nuestros últimos diseños
    </p>
  </div>

  <div
    id="gallery-grid"
    class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 w-full"
  >
    {
      images.map((img, index) => (
        <div
          class="gallery-item group relative overflow-hidden rounded-sm cursor-zoom-in aspect-3/4 lightbox-trigger"
          data-src={img.default.src}
        >
          <Image
            src={img.default}
            alt={`Diseño exclusivo ${index + 1}`}
            width={350}
            quality="mid"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
            loading={index < 10 ? "eager" : "lazy"}
          />

          <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center">
            <span class="text-xs tracking-wide border border-sakura-primary px-3 py-1 bg-black/20 backdrop-blur-[2px]">
              Ver
            </span>
          </div>
        </div>
      ))
    }
  </div>

  <div id="gallery-controls" class="w-full flex justify-center -mt-4 lg:hidden">
    <button
      id="btn-more"
      class="text-sm tracking-widest text-sakura-primary hover:text-sakura-hover border-b border-transparent hover:border-sakura-primary transition-all"
    >
      + Ver más
    </button>
    <button
      id="btn-less"
      class="hidden text-sm tracking-widest text-sakura-primary hover:text-sakura-hover border-b border-transparent hover:border-sakura-primary transition-all"
    >
      - Ver menos
    </button>
  </div>

  <a
    href={SOCIAL_LINKS.whatsapp(MESSAGES.whatsappCta)}
    target="_blank"
    class="wsp-btn flex items-center gap-2 text-sm md:text-base lg:text-lg mt-4"
    rel="noopener noreferrer"
    aria-label="Solicitar información detallada por WhatsApp"
  >
    Quiero mi diseño personalizado
    <Icon
      name="mdi:whatsapp"
      class="h-6 w-6 md:h-8 md:w-8 text-inherit"
      aria-hidden="true"
    />
  </a>
</section>

<dialog
  id="lightbox"
  class="backdrop:bg-black/90 bg-transparent p-0 m-auto max-w-[95vw] max-h-[95vh] rounded-none outline-none overflow-hidden shadow-2xl"
>
  <div class="relative w-full h-full flex items-center justify-center">
    <img
      id="lightbox-img"
      src=""
      alt="Vista ampliada"
      class="max-w-full max-h-[90vh] object-contain"
    />

    <button
      id="close-lightbox"
      class="absolute -top-2 -right-2 md:top-0 md:right-0 text-sakura-primary hover:text-sakura-hover p-4 transition-colors z-50 focus:outline-none"
      aria-label="Cerrar"
    >
      <Icon name="mdi:close" class="w-8 h-8 drop-shadow-md" />
    </button>
  </div>
</dialog>

<script>
  // --- LIGHTBOX ---
  const lightbox = document.getElementById("lightbox") as HTMLDialogElement;
  const lightboxImg = document.getElementById(
    "lightbox-img"
  ) as HTMLImageElement;
  const closeBtn = document.getElementById("close-lightbox");
  const triggers = document.querySelectorAll(".lightbox-trigger");

  if (lightbox && lightboxImg) {
    triggers.forEach((trigger) => {
      trigger.addEventListener("click", () => {
        const highResSrc = trigger.getAttribute("data-src");
        if (highResSrc) {
          lightboxImg.src = highResSrc;
          lightbox.showModal();
          document.body.style.overflow = "hidden";
        }
      });
    });

    const closeStart = () => {
      lightbox.close();
      lightboxImg.src = "";
      document.body.style.overflow = "";
    };

    closeBtn?.addEventListener("click", closeStart);
    lightbox.addEventListener("click", (event) => {
      if (event.target === lightbox) closeStart();
    });
  }

  // --- VER MÁS / VER MENOS ---
  const grid = document.getElementById("gallery-grid");
  const btnMore = document.getElementById("btn-more");
  const btnLess = document.getElementById("btn-less");

  if (grid && btnMore && btnLess) {
    btnMore.addEventListener("click", () => {
      grid.classList.add("is-expanded");
      btnMore.classList.add("hidden");
      btnLess.classList.remove("hidden");
    });

    btnLess.addEventListener("click", () => {
      grid.classList.remove("is-expanded");
      btnMore.classList.remove("hidden");
      btnLess.classList.add("hidden");
      // Scroll suave hacia arriba
      document
        .getElementById("galeria")
        ?.scrollIntoView({ behavior: "smooth" });
    });
  }
</script>

<style>
  /* --- 1. DEFINICIÓN DE VISIBILIDAD INICIAL (Sin Expanded) --- */

  /* Mobile: Ocultar items del 9 en adelante */
  #gallery-grid:not(.is-expanded) .gallery-item:nth-child(n + 9) {
    display: none;
  }

  /* Tablet: Mostrar items 9-12, Ocultar 13 en adelante */
  @media (min-width: 768px) {
    #gallery-grid:not(.is-expanded) .gallery-item:nth-child(n + 9) {
      display: block;
    }
    #gallery-grid:not(.is-expanded) .gallery-item:nth-child(n + 13) {
      display: none;
    }
  }

  /* Desktop: Mostrar todos y ocultar controles */
  @media (min-width: 1024px) {
    #gallery-grid:not(.is-expanded) .gallery-item:nth-child(n + 13) {
      display: block;
    }
    #gallery-controls {
      display: none;
    }
  }

  /* --- 2. LÓGICA DE EXPANSIÓN Y ANIMACIÓN --- */

  /* Cuando está expandido, forzamos mostrar todos */
  #gallery-grid.is-expanded .gallery-item {
    display: block !important;
  }

  /* Definimos la animación clásica "Reveal" */
  @keyframes revealItem {
    from {
      opacity: 0;
      transform: translateY(30px); /* Vienen desde abajo */
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Aplicamos animación SOLO a los items nuevos que aparecen al expandir */

  /* En Mobile: Animamos del 9 en adelante */
  #gallery-grid.is-expanded .gallery-item:nth-child(n + 9) {
    animation: revealItem 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
  }

  /* En Tablet: Los items 9-12 YA estaban visibles, así que quitamos su animación */
  /* Solo animamos del 13 en adelante */
  @media (min-width: 768px) {
    #gallery-grid.is-expanded .gallery-item:nth-child(-n + 12) {
      animation: none;
    }
    #gallery-grid.is-expanded .gallery-item:nth-child(n + 13) {
      animation: revealItem 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }
  }

  /* --- 3. ANIMACIONES LIGHTBOX --- */
  dialog[open] {
    animation: fadeIn 0.3s ease-out forwards;
  }
  dialog::backdrop {
    animation: fadeInBackdrop 0.3s ease-out forwards;
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  @keyframes fadeInBackdrop {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }
</style>
